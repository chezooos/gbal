<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ìš°ë¼ë¼</title>
    <style>
        :root {
            --bg: #0d1526;
            --panel: #111b33;
            --panel-2: #0f1830;
            --line: #1f2b4a;
            --txt: #e6eefc;
            --muted: #8fa3ca;
            --accent: #2c7df0;
            --up: #18b169;
            --down: #ea3943
        }

        * { box-sizing: border-box }
        html, body { height: 100% }
        body {
            margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            color: var(--txt); background: linear-gradient(180deg, #0b1222 0%, var(--bg) 60%)
        }

        .topbar{
            display:flex; align-items:center; justify-content:space-between; padding:10px 16px;
            border-bottom:1px solid var(--line); background:rgba(9,14,28,.8); position:sticky; top:0;
            backdrop-filter: blur(6px); z-index:10
        }
        .brand{ display:flex; gap:10px; align-items:center; font-size:18px }
        .logo{ width:24px; height:24px; display:inline-grid; place-items:center; border-radius:6px; background:var(--accent) }
        .toolbar{ display:flex; align-items:center; gap:8px; color:var(--muted) }

        .layout{ display:grid; grid-template-columns:280px 1fr 340px; gap:16px; padding:16px; max-width:1400px; margin:0 auto }
        .card{ background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--line); border-radius:12px; padding:12px }
        .card+.card{ margin-top:12px }
        .card-title{ font-size:14px; color:var(--muted); margin-bottom:8px }

        .input{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#0b1222; color:var(--txt) }
        .input.right{ text-align:right }

        .list{ list-style:none; margin:0; padding:0; max-height:48vh; overflow:auto }
        .list li{ padding:10px 12px; display:flex; justify-content:space-between; gap:8px; border-bottom:1px solid var(--line); cursor:pointer }
        .list li:hover{ background:#0e162a }
        .list .sym{ font-weight:600 }
        .list .chg{ min-width:70px; text-align:right }

        .grid2{ display:grid; grid-template-columns:1fr 360px; gap:16px }
        .mt16{ margin-top:16px }

        .price-head{ display:flex; align-items:flex-end; justify-content:space-between; gap:8px; margin-bottom:8px }
        .symbol-name{ font-size:18px; font-weight:700 }
        .symbol-code{ font-size:12px; color:var(--muted) }
        .price-now{ font-size:28px; font-weight:800 }
        .price-change{ font-size:12px; text-align:right }
        .price-change.up{ color:var(--up) }
        .price-change.down{ color:var(--down) }

        .orderbook{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
        .ob-head{ font-size:12px; color:var(--muted); margin-bottom:6px }
        .ob-head.buy{ color:#9ad1ff }
        .ob-list{ list-style:none; padding:0; margin:0; border:1px solid var(--line); border-radius:8px; overflow:hidden }
        .ob-list li{ display:grid; grid-template-columns:1fr 1fr 1fr; padding:6px 8px; border-bottom:1px solid var(--line); font-size:13px }
        .ob-list li:last-child{ border-bottom:none }
        .ob-qty{ color:var(--muted); text-align:right }
        .ob-price{ font-variant-numeric:tabular-nums; text-align:right }
        .ob-ask{ color:var(--down) }
        .ob-bid{ color:var(--up) }

        .tabs{ display:flex; gap:6px; margin-bottom:10px }
        .tab{ flex:1; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#0b1222; color:var(--txt); cursor:pointer }
        .tab.active{ background:var(--accent); border-color:transparent }

        .order-form .row{ display:grid; grid-template-columns:90px 1fr; gap:10px; align-items:center; margin:8px 0 }
        .hint{ color:var(--muted); font-size:12px; margin-top:6px }

        .primary{ background:var(--accent); border:none; color:white; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
        .ghost{ background:transparent; border:1px solid var(--line); color:var(--txt); padding:8px 10px; border-radius:10px; cursor:pointer }
        .w100{ width:100% }

        .balances{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-variant-numeric:tabular-nums }
        .table{ width:100%; border-collapse:collapse; font-size:13px }
        .table th, .table td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:right }
        .table th:first-child, .table td:first-child{ text-align:left }

        .info{ color:var(--muted); font-size:14px; line-height:1.6 }
        .footer{ padding:14px; text-align:center; color:var(--muted); border-top:1px solid var(--line); margin-top:12px }

        #authBtn{ position:relative; z-index:9999; pointer-events:auto !important }
        #authModal{ pointer-events:auto }

        @media(max-width:1200px){
            .layout{ grid-template-columns:260px 1fr }
            .pane.right{ display:none }
        }
        @media(max-width:860px){
            .layout{ grid-template-columns:1fr }
            .grid2{ grid-template-columns:1fr }
        }
    </style>

    <!-- SDK ë¨¼ì € -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± -->
    <script>
        const SB_URL = "https://habeafipujduxsqfiadf.supabase.co";
        const SB_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhYmVhZmlwdWpkdXhzcWZpYWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4ODc5NDQsImV4cCI6MjA3NzQ2Mzk0NH0.rDZghaWsitnycMpQKfwsnNJfbeoSK-z-6Uxkoiz79Rk";
        const supabase = window.supabase.createClient(SB_URL, SB_ANON_KEY);

        supabase.auth.getSession().then(({ data, error }) => {
            if (error) console.warn("Supabase ì—°ê²° ì‹¤íŒ¨:", error.message);
            else console.log("Supabase ì—°ê²° OK", data?.session ? "(ë¡œê·¸ì¸ë¨)" : "(ë¹„ë¡œê·¸ì¸)");
        });
    </script>
</head>

<body>
    <header class="topbar">
        <div class="brand"><span class="logo"><img src="ukkikii_logo.jpg" alt="" style="width: 100%;"></span><strong>UKKIKKI</strong> ëª¨ì˜ì£¼ì‹</div>
        <div class="toolbar">
            <span id="clock">--:--:--</span>
            <button id="resetBtn" class="ghost">ë¦¬ì…‹</button>
            <button id="authBtn" class="ghost">ë¡œê·¸ì¸</button>
        </div>
    </header>

    <main class="layout">
        <aside class="pane left">
            <div class="card">
                <div class="card-title">ì¢…ëª© ê²€ìƒ‰</div><input id="search" class="input" placeholder="í‹°ì»¤/ì¢…ëª©ëª… ê²€ìƒ‰" />
            </div>
            <div class="card list-card">
                <div class="card-title">ê´€ì‹¬ì¢…ëª©</div>
                <ul id="symbolList" class="list"></ul>
            </div>
        </aside>

        <section class="pane center">
            <div class="grid2">
                <div class="card price-card">
                    <div class="price-head">
                        <div>
                            <div id="symbolName" class="symbol-name">â€”</div>
                            <div id="symbolCode" class="symbol-code">â€”</div>
                        </div>
                        <div class="price-now-wrap">
                            <div id="priceNow" class="price-now">â€”</div>
                            <div id="priceChange" class="price-change">â€”</div>
                        </div>
                    </div>
                    <canvas id="chart" height="220" style="width:100%;display:block"></canvas>
                </div>
                <div class="card orderbook-card">
                    <div class="card-title">í˜¸ê°€</div>
                    <div class="orderbook">
                        <div>
                            <div class="ob-head">ë§¤ë„</div>
                            <ul id="asks" class="ob-list"></ul>
                        </div>
                        <div>
                            <div class="ob-head buy">ë§¤ìˆ˜</div>
                            <ul id="bids" class="ob-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid2 mt16">
                <div class="card">
                    <div class="tabs"><button data-tab="buy" class="tab active">ë§¤ìˆ˜</button><button data-tab="sell"
                            class="tab">ë§¤ë„</button></div>
                    <div class="order-form">
                        <div class="row"><label>ì£¼ë¬¸ìœ í˜•</label><select id="orderType" class="input">
                                <option value="market">ì‹œì¥ê°€</option>
                                <option value="limit" selected>ì§€ì •ê°€</option>
                            </select></div>
                        <div class="row" id="limitRow"><label>ì§€ì •ê°€</label><input id="limitPrice" class="input right"
                                type="number" step="1" /></div>
                        <div class="row"><label>ìˆ˜ëŸ‰</label><input id="qty" class="input right" type="number" step="1"
                                min="1" value="1" /></div>
                        <div class="row"><button id="submitOrder" class="primary w100">ì£¼ë¬¸ ì œì¶œ</button></div>
                        <div class="hint" id="orderHint">â€“</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">ë³´ìœ /ì”ê³ </div>
                    <div class="balances">
                        <div>í˜„ê¸ˆ <strong id="cash">â€”</strong></div>
                        <div>ì´ìì‚° <strong id="equity">â€”</strong></div>
                        <div>í‰ê°€ì†ìµ <strong id="pnl">â€”</strong></div>
                    </div>
                    <table class="table" id="positionsTable">
                        <thead>
                            <tr>
                                <th>ì¢…ëª©</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>í‰ë‹¨ê°€</th>
                                <th>í‰ê°€ê°€</th>
                                <th>P/L</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card mt16">
                <div class="card-title">ì²´ê²°ë‚´ì—­</div>
                <table class="table" id="fillsTable">
                    <thead>
                        <tr>
                            <th>ì‹œê°„</th>
                            <th>ì¢…ëª©</th>
                            <th>ë§¤ìˆ˜/ë§¤ë„</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ê°€ê²©</th>
                            <th>ì²´ê²°ê°€ì¹˜</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <aside class="pane right">
            <div class="card">
                <div class="card-title">ì¢…ëª© ì •ë³´</div>
                <div id="info" class="info"></div>
            </div>
            <div class="card">
                <div class="card-title">ì—´ë¦° ì£¼ë¬¸</div>
                <table class="table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©</th>
                            <th>ìœ í˜•</th>
                            <th>ë°©í–¥</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ê°€ê²©</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </aside>
    </main>

    <footer class="footer">ìš°ë¼ë¼ ëª¨ì˜ì£¼ì‹ì€ ì‹¤ì œ ì£¼ì‹ì´ ì•„ë‹ˆë¼! ğŸµ</footer>

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div id="authModal"
        style="position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:200">
        <div style="background:#0b1222;border:1px solid #1f2b4a;border-radius:12px;padding:16px;width:320px">
            <h3 style="margin:0 0 10px">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
            <input id="authEmail" class="input" placeholder="ì´ë©”ì¼" type="email" style="margin:6px 0">
            <input id="authPass" class="input" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" style="margin:6px 0">
            <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnSignIn" class="primary" style="flex:1">ë¡œê·¸ì¸</button>
                <button id="btnSignUp" class="ghost" style="flex:1">íšŒì›ê°€ì…</button>
            </div>
            <div id="authMsg" class="hint" style="margin-top:8px">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</div>
        </div>
    </div>

    <!-- Auth UI Events: DOM ìƒì„± í›„ì— ì‹¤í–‰ -->
    <script>
        document.getElementById("authBtn").onclick = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                await supabase.auth.signOut();
                alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
                location.reload();
            } else {
                document.getElementById("authModal").style.display = "flex";
            }
        };

        document.getElementById("btnSignIn").onclick = async () => {
            const email = document.getElementById("authEmail").value;
            const pass = document.getElementById("authPass").value;
            const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
            document.getElementById("authMsg").textContent = error ? error.message : "ë¡œê·¸ì¸ ì„±ê³µ";
            if (!error) location.reload();
        };

        document.getElementById("btnSignUp").onclick = async () => {
            const email = document.getElementById("authEmail").value;
            const pass = document.getElementById("authPass").value;
            const { error } = await supabase.auth.signUp({ email, password: pass });
            document.getElementById("authMsg").textContent = error ? error.message : "ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”";
        };

        document.getElementById("authModal").addEventListener("click", (e) => {
            if (e.target.id === "authModal") e.target.style.display = "none";
        });
    </script>

    <!-- ì•± ë¡œì§ (ëª¨ì˜ ì‹œì„¸/ì²´ê²° ì—”ì§„) -->
    <script>
        const symbols = [
            { code: "KOSPI", name: "ì½”ìŠ¤í”¼ ëŒ€í‘œì§€ìˆ˜", price: 2500, step: 1 },
            { code: "005930", name: "ì‚¼ì„±ì „ì", price: 75000, step: 50 },
            { code: "000660", name: "SKí•˜ì´ë‹‰ìŠ¤", price: 160000, step: 100 },
            { code: "035420", name: "NAVER", price: 190000, step: 100 },
            { code: "035720", name: "ì¹´ì¹´ì˜¤", price: 54000, step: 50 },
            { code: "051910", name: "LGí™”í•™", price: 420000, step: 100 }
        ];

        const state = { selected: "005930", ticks: {}, cash: 10000000, positions: {}, orders: [], fills: [], baseline: {} };

        const el = (id) => document.getElementById(id);
        const symbolList = el("symbolList"), symbolName = el("symbolName"), symbolCode = el("symbolCode"), priceNow = el("priceNow"), priceChange = el("priceChange");
        const asksEl = el("asks"), bidsEl = el("bids");
        const cashEl = el("cash"), equityEl = el("equity"), pnlEl = el("pnl");
        const positionsTable = el("positionsTable").querySelector("tbody"), fillsTable = el("fillsTable").querySelector("tbody"), ordersTable = el("ordersTable").querySelector("tbody");
        const info = el("info"), search = el("search"), chart = el("chart"), ctx = chart.getContext("2d"), clock = el("clock");
        const tabs = document.querySelectorAll('.tab'); let currentSide = 'buy';
        const orderType = el('orderType'), limitRow = el('limitRow'), limitPrice = el('limitPrice'), qty = el('qty'), submitOrder = el('submitOrder'), orderHint = el('orderHint');
        const fmt = (n) => n.toLocaleString('ko-KR');
        const nowTime = () => new Date().toLocaleTimeString('ko-KR', { hour12: false });
        const sym = (code) => symbols.find(s => s.code === code);

        function drawChart() {
            const arr = state.ticks[state.selected] || [];
            const w = chart.width = chart.clientWidth;
            const h = chart.height = 220;
            ctx.clearRect(0, 0, w, h);
            if (arr.length < 2) return;
            const min = Math.min(...arr), max = Math.max(...arr);
            const pad = (max - min) * 0.1 + 1;
            const y = (p) => h - ((p - (min - pad)) / ((max + pad) - (min - pad))) * h;
            const stepX = w / (arr.length - 1);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, y(arr[0]));
            for (let i = 1; i < arr.length; i++) ctx.lineTo(i * stepX, y(arr[i]));
            ctx.strokeStyle = arr[arr.length - 1] >= arr[0] ? '#18b169' : '#ea3943';
            ctx.stroke();
        }

        function renderList() {
            const q = search.value?.trim().toLowerCase();
            symbolList.innerHTML = '';
            symbols
                .filter(s => !q || s.code.includes(q) || s.name.toLowerCase().includes(q))
                .forEach(s => {
                    const ref = state.baseline[s.code] ?? s.price;
                    const pct = ref ? ((s.price - ref) / ref) * 100 : 0;
                    const sign = pct >= 0 ? '+' : '';
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="sym">${s.name}</span><span class="muted">${s.code}</span><span class="chg" id="chg-${s.code}">${sign}${pct.toFixed(2)}%</span>`;
                    if (s.code === state.selected) li.style.background = '#0e162a';
                    li.addEventListener('click', () => selectSymbol(s.code));
                    symbolList.appendChild(li);
                });
        }

        function updatePriceArea() {
            const s = sym(state.selected);
            priceNow.textContent = fmt(s.price);
            const ref = state.baseline[s.code] ?? s.price;
            const diff = s.price - ref;
            const pct = ref ? (diff / ref) * 100 : 0;
            priceChange.className = 'price-change ' + (diff >= 0 ? 'up' : 'down');
            priceChange.textContent = `${diff >= 0 ? '+' : ''}${fmt(Math.round(diff))} (${pct.toFixed(2)}%)`;
            const chgEl = document.getElementById(`chg-${s.code}`);
            if (chgEl) { chgEl.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`; chgEl.style.color = pct >= 0 ? 'var(--up)' : 'var(--down)'; }
        }

        function updateOrderbook() {
            const s = sym(state.selected);
            const asks = [], bids = [];
            for (let i = 5; i >= 1; i--) asks.push({ price: s.price + i * s.step, qty: Math.floor(Math.random() * 300 + 50) });
            for (let i = 1; i <= 5; i++) bids.push({ price: s.price - i * s.step, qty: Math.floor(Math.random() * 300 + 50) });
            asksEl.innerHTML = asks.map(a => `<li><span>ìˆ˜ëŸ‰</span><span class="ob-price ob-ask">${fmt(a.price)}</span><span class="ob-qty">${fmt(a.qty)}</span></li>`).join('');
            bidsEl.innerHTML = bids.map(b => `<li><span>ìˆ˜ëŸ‰</span><span class="ob-price ob-bid">${fmt(b.price)}</span><span class="ob-qty">${fmt(b.qty)}</span></li>`).join('');
        }

        function updateBalances() {
            const mv = Object.entries(state.positions).reduce((sum, [code, pos]) => sum + pos.qty * sym(code).price, 0);
            const equity = state.cash + mv;
            const cost = Object.values(state.positions).reduce((s, p) => s + p.qty * p.avg, 0);
            const pnl = mv - cost;
            cashEl.textContent = fmt(state.cash);
            equityEl.textContent = fmt(equity);
            pnlEl.textContent = (pnl >= 0 ? '+' : '') + fmt(Math.round(pnl));
        }

        function renderPositions() {
            positionsTable.innerHTML = '';
            for (const [code, pos] of Object.entries(state.positions)) {
                const cur = sym(code).price;
                const value = pos.qty * cur;
                const pl = (cur - pos.avg) * pos.qty;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${sym(code).name}</td><td>${fmt(pos.qty)}</td><td>${fmt(Math.round(pos.avg))}</td><td>${fmt(Math.round(value))}</td><td style="color:${pl >= 0 ? '#18b169' : '#ea3943'}">${(pl >= 0 ? '+' : '') + fmt(Math.round(pl))}</td>`;
                positionsTable.appendChild(tr);
            }
        }

        function renderFills() {
            fillsTable.innerHTML = '';
            state.fills.slice(-50).reverse().forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${f.time}</td><td>${sym(f.code).name}</td><td>${f.side === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</td><td>${fmt(f.qty)}</td><td>${fmt(f.price)}</td><td>${fmt(f.qty * f.price)}</td>`;
                fillsTable.appendChild(tr);
            })
        }

        function renderOrders() {
            ordersTable.innerHTML = '';
            state.orders.forEach(o => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${sym(o.code).name}</td><td>${o.type === 'market' ? 'ì‹œì¥' : 'ì§€ì •'}</td><td>${o.side === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</td><td>${fmt(o.qty)}</td><td>${o.price ? fmt(o.price) : '-'}</td><td><button class="ghost" data-cancel="${o.id}">ì·¨ì†Œ</button></td>`;
                ordersTable.appendChild(tr);
            });
        }

        ordersTable.addEventListener('click', (e) => {
            const id = e.target.getAttribute('data-cancel');
            if (!id) return;
            state.orders = state.orders.filter(o => o.id !== id);
            save(); renderOrders();
        });

        function placeOrder() {
            const s = sym(state.selected);
            const type = orderType.value; const side = currentSide; const n = parseInt(qty.value || '0', 10);
            const px = type === 'limit' ? parseInt(limitPrice.value || '0', 10) : null;
            if (!n || n < 1) return toast('ìˆ˜ëŸ‰ì„ í™•ì¸í•˜ì„¸ìš”.');
            if (type === 'limit' && (!px || px < 1)) return toast('ì§€ì •ê°€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');

            const order = { id: String(Date.now()) + Math.random(), side, type, code: s.code, qty: n, price: px };

            if (type === 'market') {
                execute(order, s.price);
            } else {
                const can = (side === 'buy' && px >= s.price) || (side === 'sell' && px <= s.price);
                if (can) execute(order, px); else { state.orders.push(order); toast('ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
            }
            save();
            renderOrders(); updateBalances(); renderPositions(); renderFills();
        }

        function execute(order, price) {
            const cost = price * order.qty;
            if (order.side === 'buy') {
                if (state.cash < cost) return toast('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                state.cash -= cost;
                const p = state.positions[order.code] || { qty: 0, avg: 0 };
                p.avg = (p.qty * p.avg + cost) / (p.qty + order.qty);
                p.qty += order.qty;
                state.positions[order.code] = p;
            } else {
                const p = state.positions[order.code];
                if (!p || p.qty < order.qty) return toast('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                p.qty -= order.qty;
                if (p.qty === 0) delete state.positions[order.code];
                state.cash += cost;
            }
            state.fills.push({ time: nowTime(), side: order.side, code: order.code, qty: order.qty, price });
            state.orders = state.orders.filter(o => !(o.code === order.code && o.type === 'limit' && ((o.side === 'buy' && o.price >= sym(o.code).price) || (o.side === 'sell' && o.price <= sym(o.code).price))));
            toast('ì²´ê²° ì™„ë£Œ');
        }

        function toast(msg) { orderHint.textContent = msg; setTimeout(() => orderHint.textContent = 'â€“', 2000); }

        function updateWatchlistChanges() {
            symbols.forEach(s => {
                const ref = state.baseline[s.code] ?? s.price;
                const pct = ref ? ((s.price - ref) / ref) * 100 : 0;
                const el = document.getElementById(`chg-${s.code}`);
                if (el) { el.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`; el.style.color = pct >= 0 ? 'var(--up)' : 'var(--down)'; }
            });
        }

        function tick() {
            symbols.forEach(s => {
                const vol = s.step * [1, 1, 1, 2][Math.floor(Math.random() * 4)];
                const dir = Math.random() < 0.5 ? -1 : 1;
                s.price = Math.max(s.step, s.price + dir * vol);
                if (!state.ticks[s.code]) state.ticks[s.code] = [s.price];
                const arr = state.ticks[s.code];
                arr.push(s.price); if (arr.length > 150) arr.shift();
            });

            state.orders = state.orders.filter(o => {
                const s = sym(o.code);
                if (o.type === 'limit') {
                    if ((o.side === 'buy' && o.price >= s.price) || (o.side === 'sell' && o.price <= s.price)) {
                        execute(o, o.price); return false;
                    }
                }
                return true;
            });

            updatePriceArea();
            updateOrderbook();
            drawChart();
            updateBalances();
            renderPositions();
            renderFills();
            renderOrders();
            updateWatchlistChanges();
            save();
        }

        function save() { localStorage.setItem("mocktrade", JSON.stringify({ state })); }
        function load() { const raw = localStorage.getItem("mocktrade"); if (!raw) return; try { const obj = JSON.parse(raw); Object.assign(state, obj.state); } catch { } }

        function setBaselines() { symbols.forEach(s => { state.baseline[s.code] = s.price; }); }

        function selectSymbol(code) {
            state.selected = code; save();
            const s = sym(code);
            symbolName.textContent = s.name;
            symbolCode.textContent = s.code;
            limitPrice.value = s.price;
            updatePriceArea();
            renderList();
            updateInfo();
            drawChart();
            updateWatchlistChanges();
        }

        function updateInfo() {
            const s = sym(state.selected);
            info.innerHTML = `
      <div>ì¢…ëª©ëª…: <strong>${s.name}</strong></div>
      <div>ì½”ë“œ: <strong>${s.code}</strong></div>
      <div>í˜¸ê°€ë‹¨ìœ„: <strong>${fmt(s.step)}</strong></div>
      <div class="hint">ì‹œì„¸ëŠ” ì„ì˜ ë‚œìˆ˜ë¡œ ìƒì„±ë©ë‹ˆë‹¤. í•™ìŠµìš©ì…ë‹ˆë‹¤.</div>`;
        }

        search.addEventListener('input', renderList);
        tabs.forEach(btn => btn.addEventListener('click', () => {
            tabs.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSide = btn.dataset.tab;
            submitOrder.textContent = currentSide === 'buy' ? 'ë§¤ìˆ˜ ì£¼ë¬¸' : 'ë§¤ë„ ì£¼ë¬¸';
        }));
        orderType.addEventListener('change', () => { const isLimit = orderType.value === 'limit'; limitRow.style.display = isLimit ? 'grid' : 'none'; });
        submitOrder.addEventListener('click', placeOrder);
        limitPrice.addEventListener('focus', () => limitPrice.select());

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (!confirm('ë§¤ìˆ˜/ë§¤ë„ ë‚´ì—­ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
            state.positions = {};
            state.orders = [];
            state.fills = [];
            state.cash = 10000000;
            save();
            renderPositions();
            renderOrders();
            renderFills();
            updateBalances();
            orderHint.textContent = 'ë‚´ ê±°ë˜ë‚´ì—­ ì´ˆê¸°í™” ì™„ë£Œ';
            setTimeout(() => orderHint.textContent = 'â€“', 1500);
        });

        window.addEventListener('resize', drawChart);

        function init() {
            load();
            setBaselines();
            renderList();
            selectSymbol(state.selected);
            updateOrderbook();
            updateBalances();
            renderPositions();
            renderFills();
            renderOrders();
            drawChart();
            setInterval(tick, 1000);
            setInterval(() => clock.textContent = nowTime(), 250);
        }
        init();
    </script>

    <!-- Supabase: í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° -->
    <script>
        async function saveToDB() {
            try {
                if (!window.supabase) return;
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                await supabase.from('portfolios').upsert({ user_id: user.id, state: window.state });
            } catch (e) { console.warn('saveToDB error:', e); }
        }

        async function loadFromDB(uid) {
            try {
                const { data, error } = await supabase
                    .from('portfolios')
                    .select('state')
                    .eq('user_id', uid)
                    .maybeSingle();
                if (error) { console.warn('loadFromDB error:', error.message); return; }
                if (data?.state) { Object.assign(window.state, data.state); }
            } catch (e) { console.warn('loadFromDB error:', e); }
        }

        supabase.auth.onAuthStateChange(async (_ev, session) => {
            const user = session?.user || null;
            const authBtn = document.getElementById('authBtn');
            if (authBtn) authBtn.textContent = user ? 'ë¡œê·¸ì•„ì›ƒ' : 'ë¡œê·¸ì¸';

            if (user) {
                await loadFromDB(user.id);
                if (!window.state.baseline) window.state.baseline = {};
                try {
                    if (typeof renderList === 'function') renderList();
                    if (typeof updateWatchlistChanges === 'function') updateWatchlistChanges();
                    if (typeof updatePriceArea === 'function') updatePriceArea();
                    if (typeof updateBalances === 'function') updateBalances();
                    if (typeof renderPositions === 'function') renderPositions();
                    if (typeof renderFills === 'function') renderFills();
                    if (typeof renderOrders === 'function') renderOrders();
                    if (typeof drawChart === 'function') drawChart();
                    if (typeof updateInfo === 'function') updateInfo();
                } catch (_) { }
                const hint = document.getElementById('orderHint');
                if (hint) { hint.textContent = 'ë¡œê·¸ì¸ ìƒíƒœ ë™ê¸°í™” ì™„ë£Œ'; setTimeout(() => hint.textContent = 'â€“', 1200); }
            }
        });

        // save() í˜¸ì¶œ ì‹œ DBë„ í•¨ê»˜ ì €ì¥
        (function patchSave() {
            const orig = window.save;
            if (typeof orig === 'function') {
                window.save = function (...args) {
                    const r = orig.apply(this, args);
                    saveToDB();
                    return r;
                };
            }
        })();
    </script>
    <script>
        /* === ìµœì¢… ë³´ì • v2: authBtn ê°•ì œ ë™ì‘ ë³´ì¥ (passive ì œê±°) === */
        (function ensureAuthButtonWorks() {
            const btn = document.getElementById('authBtn');
            if (btn) btn.setAttribute('type', 'button');

            document.addEventListener('click', async (e) => {
                const targetBtn = e.target.closest('#authBtn');
                if (!targetBtn) return;

                e.preventDefault();
                e.stopPropagation();

                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        await supabase.auth.signOut();
                        alert('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                        location.reload();
                    } else {
                        const modal = document.getElementById('authModal');
                        if (modal) modal.style.display = 'flex';
                    }
                } catch (err) {
                    console.error('authBtn handler error:', err);
                    alert('ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ì—†ì–´ìš”. ì½˜ì†” ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì¤˜.');
                }
            }, { capture: true });

            const cssFix = document.createElement('style');
            cssFix.textContent = `
                #authBtn { pointer-events:auto !important; position:relative; z-index:10000; }
                .topbar, .toolbar { pointer-events:auto !important; }
            `;
            document.head.appendChild(cssFix);
        })();
    </script>
    <script>
        /* ===== MockTrade x Supabase ê°•ì œ ë™ê¸°í™” íŒ¨ì¹˜ (ë§ë¶™ì´ê¸° ì „ìš©) ===== */
        (function () {
            const log = (...a) => console.log('[DBSYNC]', ...a);
            const warn = (...a) => console.warn('[DBSYNC]', ...a);

            if (!window.supabase) { warn('supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŒ.'); return; }

            if (typeof window.saveToDB !== 'function') {
                window.saveToDB = async function saveToDB() {
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (!user) { log('skip: ë¹„ë¡œê·¸ì¸'); return; }
                        log('UPSERT start', { uid: user.id });
                        await supabase.from('portfolios').upsert({ user_id: user.id, state: window.state });
                        log('UPSERT ok');
                    } catch (e) { warn('saveToDB error(ì‹ ê·œ):', e?.message || e); }
                };
                log('saveToDB: ì‹ ê·œ ì •ì˜ ì™„ë£Œ');
            } else {
                const origSaveToDB = window.saveToDB;
                window.saveToDB = async function wrappedSaveToDB(...args) {
                    log('saveToDB í˜¸ì¶œ');
                    try {
                        const r = await origSaveToDB.apply(this, args);
                        log('saveToDB ì™„ë£Œ'); return r;
                    } catch (e) { warn('saveToDB error(ë˜í•‘):', e?.message || e); }
                };
                log('saveToDB: ë˜í•‘ ì ìš©');
            }

            if (typeof window.save === 'function') {
                const origSave = window.save;
                window.save = function patchedSave(...args) {
                    const r = origSave.apply(this, args);
                    Promise.resolve().then(() => window.saveToDB()).catch((e) => warn('patched save->saveToDB error:', e?.message || e));
                    return r;
                };
                log('save() íŒ¨ì¹˜ ì™„ë£Œ');
            } else {
                warn('save() í•¨ìˆ˜ê°€ ì•„ì§ ì—†ìŒ.');
            }

            const hookSubmitBtn = () => {
                const btn = document.getElementById('submitOrder');
                if (!btn) return false;
                btn.addEventListener('click', () => {
                    setTimeout(() => window.saveToDB(), 50);
                    log('submitOrder í´ë¦­ -> saveToDB ì˜ˆì•½');
                });
                return true;
            };
            if (!hookSubmitBtn()) {
                const t = setInterval(() => { if (hookSubmitBtn()) { clearInterval(t); log('submitOrder í›„í¬ ì§€ì—° ì—°ê²° ì™„ë£Œ'); } }, 150);
            } else {
                log('submitOrder í›„í¬ ì—°ê²° ì™„ë£Œ');
            }

            const fillsTbody = document.querySelector('#fillsTable tbody');
            const ordersTbody = document.querySelector('#ordersTable tbody');
            const mo = (tb) => {
                if (!tb) return;
                const obs = new MutationObserver(() => {
                    clearTimeout(tb.__saveTimer);
                    tb.__saveTimer = setTimeout(() => {
                        log('DOM ë³€í™” ê°ì§€ -> saveToDB');
                        window.saveToDB();
                    }, 120);
                });
                obs.observe(tb, { childList: true, subtree: false });
            };
            mo(fillsTbody);
            mo(ordersTbody);

            supabase.auth.onAuthStateChange(async (_e, session) => {
                const user = session?.user;
                if (user) {
                    log('auth state -> ë¡œê·¸ì¸ ê°ì§€, DB ë¡œë“œ í›„ ì €ì¥');
                    try {
                        if (typeof window.loadFromDB === 'function') {
                            await window.loadFromDB(user.id);
                        }
                        await window.saveToDB();
                    } catch (e) { warn('auth sync error:', e?.message || e); }
                } else {
                    log('auth state -> ë¡œê·¸ì•„ì›ƒ');
                }
            });

        })();
    </script>
    <script>
        /* === ì£¼ë¬¸ ì œì¶œ ì‹œ Supabase UPSERTë¥¼ ë¬´ì¡°ê±´ íƒœìš°ëŠ” ë³´ì¡° í›… === */
        (async function forceDbSaveOnSubmit(){
          async function waitClient(){
            let tries = 0;
            while(!(window.supabase && window.supabase.auth && typeof window.supabase.auth.getUser === 'function') && tries < 100){
              await new Promise(r=>setTimeout(r,50));
              tries++;
            }
            if(!(window.supabase && window.supabase.auth)) throw new Error('Supabase client not ready');
            return window.supabase;
          }
          const s = await waitClient();

          function hook(){
            const btn = document.getElementById('submitOrder');
            if(!btn) return false;
            btn.addEventListener('click', async ()=>{
              setTimeout(async ()=>{
                try{
                  const { data:{ user } } = await s.auth.getUser();
                  if(!user){ console.warn('[forceDb] ë¹„ë¡œê·¸ì¸ì´ë¼ ì €ì¥ ìŠ¤í‚µ'); return; }
                  const payload = { user_id: user.id, state: window.state || {} };
                  const { data, error } = await s.from('portfolios').upsert(payload).select('user_id, updated_at');
                  if(error) console.warn('[forceDb] upsert error:', error.message);
                  else      console.log('[forceDb] upsert ok:', data);
                }catch(e){ console.warn('[forceDb] exception:', e?.message || e); }
              }, 60);
            });
            console.log('[forceDb] submitOrder í›… ì—°ê²° ì™„ë£Œ');
            return true;
          }
          if(!hook()){
            const t = setInterval(()=>{ if(hook()) clearInterval(t); }, 150);
          }
        })();
    </script>

    <!-- ======= ê°€ìƒ ë‰´ìŠ¤ + ëª¨ë©˜í…€ (ADD-ONLY) ======= -->
    <script>
    (function () {
      // ìŠ¤íƒ€ì¼ (UI ë³€ê²½ ì—†ì´ í† ìŠ¤íŠ¸ë§Œ ë– ìš”)
      const style = document.createElement('style');
      style.textContent = `
        .news-toast{
          position:fixed; top:8px; right:12px; z-index:9998;
          background:rgba(13,21,38,.95); border:1px solid #1f2b4a; color:#e6eefc;
          padding:10px 12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
          max-width:320px; font-size:13px; line-height:1.45
        }
        .news-toast h4{margin:0 0 4px; font-size:13px; color:#8fa3ca; font-weight:700}
        .news-toast .pos{color:#18b169} .news-toast .neg{color:#ea3943}
      `;
      document.head.appendChild(style);

      function showNewsToast(html, ms=8000){
        const el = document.createElement('div');
        el.className = 'news-toast';
        el.innerHTML = html;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), ms);
      }

      const TEMPLATES = [
        { title:'ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ìˆ˜ìš” {x}%â†‘', body:'ê¸€ë¡œë²Œ í´ë¼ìš°ë“œ CAPEX í™•ëŒ€. ì‚¼ì„±ì „ìÂ·SKí•˜ì´ë‹‰ìŠ¤ ìˆ˜í˜œ ê¸°ëŒ€.',
          affects:{ '000660': +1.0, '005930': +0.6 } },
        { title:'í”Œë«í¼ ê·œì œ ì´ìŠˆ ì¬ì í™”', body:'ìˆ˜ìˆ˜ë£Œ ì ê²€ ì´ìŠˆë¡œ NAVERÂ·ì¹´ì¹´ì˜¤ ë³€ë™ì„± í™•ëŒ€.',
          affects:{ '035420': -0.8, '035720': -0.9 } },
        { title:'2ì°¨ì „ì§€ ì›ì¬ë£Œ ê°€ê²© ê¸‰ë½', body:'ì „ê³ ì²´ ë°°í„°ë¦¬ ê¸°ëŒ€ ì¬ë¶€ê°. LGí™”í•™ íˆ¬ìì‹¬ë¦¬ ê°œì„ .',
          affects:{ '051910': +0.9 } },
        { title:'í™˜ìœ¨ ê¸‰ë“±, ìˆ˜ì¶œ ëŒ€í˜•ì£¼ ê°•ì„¸', body:'ì›í™” ì•½ì„¸ë¡œ IT ëŒ€í˜•ì£¼ ìˆ˜í˜œ.',
          affects:{ '005930': +0.7, '000660': +0.7 } },
        { title:'í”Œë«í¼ ê´‘ê³  ë§¤ì¶œ ë‘”í™”', body:'ê²½ê¸° ë‘”í™” ì—¬íŒŒë¡œ ê´‘ê³ ì£¼ ë³´ìˆ˜ì . NAVERÂ·ì¹´ì¹´ì˜¤ ì‹¤ì  ìš°ë ¤.',
          affects:{ '035420': -0.7, '035720': -0.6 } },
        { title:'ë°˜ë„ì²´ ì—…í™© ì¡°ì •', body:'Dë¨ ê³ ì •ê°€ í•˜ë½ ì†Œì‹. ë‹¨ê¸° ì°¨ìµ ë§¤ë¬¼ ì¶œíšŒ.',
          affects:{ '000660': -1.0, '005930': -0.5 } },
      ];

      const impulse = {}; // ì½”ë“œë³„ ëˆ„ì  ëª¨ë©˜í…€
      function addImpulse(map){
        for(const code in map){
          impulse[code] = (impulse[code]||0) + map[code];
        }
      }

      function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

      function spawnNews(){
        const _symbols = (window.symbols || (typeof symbols!=='undefined'?symbols:[]));
        if(!_symbols || !_symbols.length) return;

        const tpl = TEMPLATES[rand(0, TEMPLATES.length-1)];
        const x = rand(2,8);
        const title = tpl.title.replace('{x}', x);
        const body  = tpl.body;

        const dirClass = Object.values(tpl.affects).some(v=>v<0)?'neg':'pos';
        showNewsToast(`<h4>ì†ë³´ Â· ê°€ìƒë‰´ìŠ¤</h4><div class="${dirClass}"><strong>${title}</strong></div><div>${body}</div>`);

        const bump = {};
        for(const code in tpl.affects){
          bump[code] = tpl.affects[code] * (0.8 + Math.random()*0.6); // ê°•ë„ 0.8~1.4ë°°
        }
        addImpulse(bump);
      }

      function applyImpulse(){
        const _symbols = (window.symbols || (typeof symbols!=='undefined'?symbols:[]));
        const _state = (window.state || (typeof state!=='undefined'?state:null));
        if(!_symbols || !_state) return;

        let changed = false;
        for(const s of _symbols){
          const imp = impulse[s.code];
          if(!imp) continue;

          const delta = Math.sign(imp) * Math.max(1, Math.round(Math.abs(imp) * (1 + Math.random()*0.5))) * s.step;
          const newPx = Math.max(s.step, s.price + delta);
          if(newPx !== s.price){
            s.price = newPx;
            changed = true;
            const arr = (_state.ticks[s.code] ||= [s.price]);
            arr[arr.length-1] = s.price;
          }
          impulse[s.code] *= 0.90;
          if(Math.abs(impulse[s.code]) < 0.05) delete impulse[s.code];
        }
        if(changed){
          try{
            if(typeof updatePriceArea==='function') updatePriceArea();
            if(typeof updateOrderbook==='function') updateOrderbook();
            if(typeof drawChart==='function') drawChart();
            if(typeof updateBalances==='function') updateBalances();
            if(typeof renderPositions==='function') renderPositions();
            if(typeof updateWatchlistChanges==='function') updateWatchlistChanges();
          }catch(_){}
        }
      }

      setTimeout(spawnNews, 10000);   // ì‹œì‘ 10ì´ˆ í›„ ì²« ë‰´ìŠ¤
      setInterval(spawnNews, 60000);  // ë§¤ 1ë¶„
      setInterval(applyImpulse, 1000); // ë§¤ì´ˆ ëª¨ë©˜í…€ ì ìš©
    })();
    </script>
</body>
</html>
